= form_for([:official, @race], html: { class: 'form' }) do |f|
  = render partial: 'shared/form_errors', locals: { item: @race }
  %h2= t 'official.races.form.basic_information'
  = f.hidden_field :sport_key
  .form__field.form__field--md.row
    .col-xs-12.col-sm-3= f.label :sport_key
    .col-xs-12.col-sm-9= t "sport_name.#{@race.sport_key}"
  .form__field.form__field--md.row
    .col-xs-12.col-sm-3= f.label :level
    .col-xs-12.col-sm-9= f.select :level, Race::ALL_LEVELS.reverse.map {|level| [t("levels.#{level}"), level]}, include_blank: t(:choose)
  .form__field.row
    .col-xs-12.col-sm-3= f.label :name
    .col-xs-12.col-sm-9= f.text_field :name
  .form__field.form__field--md.row
    .col-xs-12.col-sm-3= f.label :district
    .col-xs-12.col-sm-9= f.collection_select(:district_id, District.all, :id, :name, prompt: true)
  .form__field.row
    .col-xs-12.col-sm-3= f.label :location
    .col-xs-12.col-sm-9= f.text_field :location
  - start_year = [Date.today.year - 1, @race.start_date.year].min
  .form__field.form__field--date.row
    .col-xs-12.col-sm-3= f.label :start_date
    .col-xs-12.col-sm-9= f.date_select :start_date, start_year: start_year, end_year: Date.today.year + 1
  .form__field.form__field--sm.row
    .col-xs-12.col-sm-3= f.label :start_time
    .col-xs-12.col-sm-9= f.time_select :start_time, value: @race.start_time
  .form__field.form__field--md.row
    .col-xs-12.col-sm-3= f.label :days_count
    .col-xs-12.col-sm-9= f.select :days_count, 7.times.map {|i| [t(:days, count: i + 1), i + 1]}
  .form__field.row
    .col-xs-12.col-sm-3
      %label= t 'official.races.form.competitor_organisation'
    .col-xs-12.col-sm-9
      = f.radio_button :club_level, Race::CLUB_LEVEL_SEURA
      = f.label "club_level_#{Race::CLUB_LEVEL_SEURA}", t(:club), class: 'form__label--radio'
      = f.radio_button :club_level, Race::CLUB_LEVEL_PIIRI
      = f.label "club_level_#{Race::CLUB_LEVEL_PIIRI}", t(:district), class: 'form__label--radio'
  - if @race.sport.start_list?
    .form__field.row
      .col-xs-12.col-sm-3
        .form__help-label
          = f.label :reveal_distances
          %a.help#reveal_distances_help{href: 'javascript:void(0);'} ?
      .col-xs-12.col-sm-9= f.check_box :reveal_distances
  - unless @race.new_record?
    .form__field.row
      .col-xs-12.col-sm-3= f.label :cancelled
      .col-xs-12.col-sm-9= f.check_box :cancelled
  %h2= t 'official.races.form.organizer_information'
  .form__field.row
    .col-xs-12.col-sm-3= f.label :organizer
    .col-xs-12.col-sm-9= f.text_field :organizer
  .form__field.row
    .col-xs-12.col-sm-3
      .form__help-label
        = f.label :address
        %a.help#address_help{href: 'javascript:void(0);'} ?
    .col-xs-12.col-sm-9= f.text_field :address
  .form__field.row
    .col-xs-12.col-sm-3
      .form__help-label
        = f.label :home_page, t('official.races.form.link_to_race_home_page')
        %a.help#home_page_help{href: 'javascript:void(0);'} ?
    .col-xs-12.col-sm-9= f.url_field :home_page
  .form__field.form__field--md.row
    .col-xs-12.col-sm-3= f.label :organizer_phone
    .col-xs-12.col-sm-9= f.telephone_field :organizer_phone
  .form__field.row
    .col-xs-12.col-sm-3
      .form__help-label
        = f.label :public_message
        %a.help#public_message_help{href: 'javascript:void(0);'} ?
    .col-xs-12.col-sm-9= f.text_area :public_message, cols: 50, rows: 6

  - if @race.sport.start_list?
    #reveal_distances_help_dialog.dialog{style: 'display:none;'}
      %h3 Kun asetus ei ole valittuna
      Normaalisti oikeat etäisyydet paljastetaan vasta, kun kilpailu on merkitty päättyneeksi.
      Tällä tavoin voidaan helposti varmistaa, etteivät kilpailijat saa tietää niitä ennen kuin
      ovat suorittaneet matkansa. Arviopisteet näytetään kuitenkin heti, kun kilpailijalle on
      tiedossa sekä arviot että hänen lähtönumeronsa oikeat etäisyydet.
      %h3 Kun asetus on valittuna
      Jos tämä asetus laitetaan päälle, kilpailijan kohdalla näytetään oikeat etäisyydet heti,
      kun ne ovat tiedossa. Tätä vaihtoehtoa voidaan käyttää esim. monipäiväisissä kilpailuissa,
      joissa joka päivälle on eri arviomatkat. Toimitsijan vastuulla on tällöin tallentaa oikeat
      etäisyydet vasta silloin, kun kaikki päivän kilpailijat ovat tulleet maaliin.

  #home_page_help_dialog.dialog{style: 'display:none;'}
    Jos kilpailusta on tarjolla lisätietoa esimerkiksi piirin tai seuran
    omilla sivuilla, voit laittaa tähän linkin kyseiselle sivulle.
    Voit myös jättää kentän tyhjäksi.

  #batch_size_help_dialog.dialog{style: 'display:none;'}
    Lähtöerien avulla voit luoda taukoa kilpailijoiden välille.
    Voit esimerkiksi määrittää lähtöerän kooksi 20 kilpailijaa,
    jonka jälkeen tulee lähtöajoissa tauko. Nämä asetukset otetaan huomioon,
    kun luodaan lähtölistoja.<br/><br/>
    Mikäli haluat, että kaikki kilpailijat lähtevät tasaisin väliajoin,
    jätä kentän arvoksi 0.<br/><br/>
    Lähtöeriä käytetään yleensä suuremmissa kilpailuissa, jotta esimerkiksi
    ammuntapaikoille ei tulisi liikaa ruuhkaa.

  #start_order_help_dialog.dialog{style: 'display:none;'}
    Kilpailijoiden lähtöjärjestys vaikuttaa siihen, kuinka lähtölistat luodaan.
    %h3 Pääsääntöisesti sarjoittain
    Tässä vaihtoehdossa kilpailijat lähtevät liikkeelle pääsääntöisesti sarja
    kerrallaan (poikkeukset ovat siis mahdollisia). Toimitsijan kannalta se tarkoittaa
    sitä, että kun olet syöttänyt sarjan kilpailijat, voit järjestelmän avulla
    luoda sarjalle kätevästi lähtölistan.
    %h3 Sarjat sekaisin
    Tässä vaihtoehdossa kilpailijoiden sarjat eivät vaikuta lähtöaikaan, pikemminkin
    kilpailijoiden lisäysjärjestys. Toimitsijan kannalta tämä tarkoittaa sitä,
    että kun olet lisäämässä kilpailijaa, sinun täytyy myös määrittää hänelle lähtöaika
    ja lähtönumero. Lähtölistat syntyvät näin ollen samalla, kun lisäät kilpailijoita.

  #address_help_dialog.dialog{style: 'display:none;'}
    Kilpailupaikan osoite. Syötä osoite sellaisessa muodossa, jossa Google sen tunnistaa,
    esim. "Kilpailukatu 15, Kisakylä".
    %p Kilpailun etusivulle luodaan Google Maps -linkki tämän osoitteen avulla.

  #public_message_help_dialog.dialog{style: 'display:none;'}
    Tähän kenttään kirjoittamasi viesti tulee näkyviin kilpailun etusivulle.
    Voit tiedottaa sen avulla kilpailun tärkeistä asioista kilpailijoille ja kilpailua seuraavalla yleisölle.
    %p
      Voit muotoilla tekstiä tai lisätä linkkejä
      = link_to 'markdown-tekniikan', 'https://www.markdownguide.org/cheat-sheet/', target: '_blank'
      avulla.

  - if @race.sport.start_list?
    %h2= t 'official.races.form.start_times'
    .form__field.form__field--sm.row
      .col-xs-12.col-sm-3= f.label :start_interval_seconds
      .col-xs-12.col-sm-9
        = f.number_field :start_interval_seconds, maxlength: 3
        = t 'official.races.form.seconds'
    .form__field.row
      .col-xs-12.col-sm-3
        .form__help-label
          = f.label :start_order, t('attributes.start_order')
          %a.help#start_order_help{href: 'javascript:void(0);'} ?
      .col-xs-12.col-sm-9
        = f.radio_button :start_order, Race::START_ORDER_NOT_SELECTED, style: 'display:none;'
        = f.radio_button :start_order, Race::START_ORDER_BY_SERIES
        = f.label "start_order_#{Race::START_ORDER_BY_SERIES}", t('official.races.form.competitors_start_order_series'), class: 'form__label--radio'
        = f.radio_button :start_order, Race::START_ORDER_MIXED
        = f.label "start_order_#{Race::START_ORDER_MIXED}", t('official.races.form.competitors_start_order_mixed'), class: 'form__label--radio'

    .form__field.form__field--sm.batch_size_row.row
      .col-xs-12.col-sm-3
        .form__help-label
          = f.label :batch_size
          %a.help#batch_size_help{href: 'javascript:void(0);'} ?
      .col-xs-12.col-sm-9
        = f.number_field :batch_size, maxlength: 3
        (0 = #{t 'official.races.form.start_batches_not_in_use'})

    .form__field.form__field--sm.batch_size_row.row
      .col-xs-12.col-sm-3= f.label :batch_interval_seconds
      .col-xs-12.col-sm-9
        = f.number_field :batch_interval_seconds, maxlength: 3
        = t 'official.races.form.seconds'

  - if @race.sport.batch_list?
    %h2= t :batch_list
    .form__field.form__field--sm.row
      .col-xs-12.col-sm-3= f.label :track_count
      .col-xs-12.col-sm-9= f.number_field :track_count, maxlength: 2
    .form__field.form__field--sm.row
      .col-xs-12.col-sm-3= f.label :shooting_place_count
      .col-xs-12.col-sm-9= f.number_field :shooting_place_count, maxlength: 3
    .form__field.form__field--sm.row
      - label = @race.sport.one_batch_list? ? t('attributes.hide_batches') : nil
      .col-xs-12.col-sm-3= f.label :hide_qualification_round_batches, label
      .col-xs-12.col-sm-9= f.check_box :hide_qualification_round_batches
    - unless @race.sport.one_batch_list?
      .form__field.form__field--sm.row
        .col-xs-12.col-sm-3= f.label :hide_final_round_batches
        .col-xs-12.col-sm-9= f.check_box :hide_final_round_batches

  - unless @race.new_record? || @race.api_secret.blank?
    %h2 API
    .form__field.form__field--md.row
      .col-xs-12.col-sm-3= t :race_id
      .col-xs-12.col-sm-9= @race.id
    .form__field.form__field--md.row
      .col-xs-12.col-sm-3= t 'attributes.api_secret'
      .col-xs-12.col-sm-9
        %a{href: '#', onClick: "event.preventDefault(); $('#api_secret').show(); $(this).hide()"}= t :show
        %span#api_secret{style: 'display: none'}= @race.api_secret

  - if @race.new_record?
    %h2= t 'activerecord.models.series.other'
    .form__field.row
      .col-xs-12.col-sm-3
        .form__help-label
          = label_tag :add_default_series, t('official.races.new.add_default_series_automatically')
          %a.help#default_series_help{href: 'javascript:void(0);'} ?
      .col-xs-12.col-sm-9= check_box_tag :add_default_series, '1', params[:add_default_series]

    #default_series_help_dialog.dialog{style: 'display:none;'}
      Jos merkitset 'Lisää oletussarjat automaattisesti'-kentän valituksi,
      kilpailulle luodaan automaattisesti seuraavat sarjat:
      %ul
        - DefaultSeries.all(@race.sport).each do |df|
          %li
            - if df.default_age_groups.empty?
              = df.name
            - else
              #{df.name} (#{(df.default_age_groups.collect &:name).join(', ')})
      Voit kilpailun lisäämisen jälkeen tarvittaessa poistaa tarpeettomat sarjat
      ja lisätä uusia.
      %p Mikäli et valitse tätä vaihtoehtoa, pääset lisäämään haluamasi sarjat heti kilpailun jälkeen.

    - unless current_user.races.empty?
      .form__field.row
        .col-xs-12.col-sm-3= label_tag :add_default_series, t('official.races.new.copy_series')
        .col-xs-12.col-sm-9= select_tag :copy_series, options_from_collection_for_select(current_user.races, :id, lambda {|r| "#{r.name}, #{r.location}, #{race_date_interval(r, false)}"}, params[:copy_series]), prompt: '- Ei kopiointia -'

  - else
    .form__buttons
      = submit_tag submit_label, class: 'button button--primary'
    %h2= t 'activerecord.models.series.other'
    = f.fields_for :series do |series_form|
      = render partial: 'series', locals: { f: series_form }
    - if @race.series.empty?
      = highlight_info(t 'official.races.form.you_havent_added_series_yet')
    = add_child_link t('official.races.form.add_series'), f, :series, nil, 'button button--add'
  .form__buttons
    = submit_tag submit_label, class: 'button button--primary'

:javascript
  var reveal_distances_help_title = 'Paljasta oikeat etäisyydet heti';
  var home_page_help_title = 'Linkki kilpailun sivuille';
  var address_help_title = 'Kilpailupaikan osoite';
  var public_message_help_title = '#{t 'attributes.public_message'}';
  var start_order_help_title = 'Kilpailijoiden lähtöjärjestys';
  var batch_size_help_title = 'Lähtöerät';
  var default_series_help_title = 'Lisää oletussarjat automaattisesti';
  var age_groups_help_title = '#{@race.sport.shooting? ? 'Aliryhmät' : 'Ikäryhmät'}';

  function showOrHideBatchSizes() {
    if($("#race_start_order_" + #{Race::START_ORDER_BY_SERIES} + ":checked").length) {
      $(".batch_size_row").show();
    } else {
      $(".batch_size_row").hide();
    }
  }
  $(document).ready(showOrHideBatchSizes);
  $("#race_start_order_" + #{Race::START_ORDER_BY_SERIES}).click(showOrHideBatchSizes);
  $("#race_start_order_" + #{Race::START_ORDER_MIXED}).click(showOrHideBatchSizes);

  $('#add_default_series').change(setSeriesMethodEnabling)
  $('#copy_series').change(setSeriesMethodEnabling)

  function setSeriesMethodEnabling() {
    var defaultSeries = $('#add_default_series')[0].checked
    var copySeries = !!$('#copy_series').val()
    if (defaultSeries) {
      $('#copy_series').attr('disabled', true)
    } else if (copySeries) {
      $('#add_default_series').attr('disabled', true)
    } else {
      $('#copy_series').removeAttr('disabled')
      $('#add_default_series').removeAttr('disabled')
    }
  }
= render :partial => 'shared/help_dialog_opener'
